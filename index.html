<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Wanchain Bridge Explorer - Pro View</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; font-size: 15px; }
        .mono { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .input-pill { background: #fff; border: 2px solid #e2e8f0; padding: 14px 18px; border-radius: 14px; transition: all 0.2s; font-size: 16px; }
        .input-pill:focus { border-color: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); outline: none; }
        .suggest-container { position: relative; }
        .suggest-list { position: absolute; top: calc(100% + 5px); left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); z-index: 100; max-height: 240px; overflow-y: auto; display: none; }
        .suggest-item { padding: 12px 18px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .suggest-item:hover { background: #f1f5f9; color: #4f46e5; font-weight: 600; }
        .fee-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e2e8f0; }
        .fee-item:last-child { border-bottom: none; }
        .json-block { background: #1e293b; color: #94a3b8; border-radius: 12px; padding: 20px; font-size: 13px; line-height: 1.6; overflow-x: auto; }
        .result-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); margin-bottom: 24px; }
        .badge-pct { background: #e0e7ff; color: #4338ca; font-size: 10px; padding: 2px 6px; border-radius: 6px; font-weight: 800; margin-left: 4px; vertical-align: middle; }
        .header-pill { background-color: #e0e7ff; color: #4338ca; padding: 4px 8px; border-radius: 8px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; margin-right: 8px; margin-bottom: 8px; }
        .header-pill button { margin-left: 8px; background: none; border: none; cursor: pointer; color: #4338ca; font-weight: 800; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #e2e8f0; text-align: left; }
        th { background-color: #f1f5f9; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <h1 class="text-3xl font-black tracking-tight">WAN BRIDGE <span class="text-indigo-600">HUB</span></h1>
            <div class="bg-white border-2 border-slate-200 p-1 rounded-2xl flex shadow-sm">
                <button onclick="changeEnv(false)" id="btnMain" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all">主网</button>
                <button onclick="changeEnv(true)" id="btnTest" class="px-8 py-2.5 rounded-xl text-sm font-bold transition-all">测试网</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <section class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 mb-10">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="suggest-container">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block ml-1">Asset 资产</label>
                            <input type="text" id="assetIn" autocomplete="off" placeholder="例如: BTC" class="input-pill w-full" oninput="showSuggestions('assetIn', 'assetSuggest', 'asset')">
                            <div id="assetSuggest" class="suggest-list"></div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                            <div class="suggest-container">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block ml-1">Network A 链</label>
                                <input type="text" id="chainA" autocomplete="off" placeholder="例如: BSC" class="input-pill w-full" oninput="showSuggestions('chainA', 'chainASuggest', 'chain')">
                                <div id="chainASuggest" class="suggest-list"></div>
                            </div>
                            <div class="suggest-container">
                                <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block ml-1">Network B 链</label>
                                <input type="text" id="chainB" autocomplete="off" placeholder="例如: Cardano" class="input-pill w-full" oninput="showSuggestions('chainB', 'chainBSuggest', 'chain')">
                                <div id="chainBSuggest" class="suggest-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between items-center">
                        <div id="dataStatus" class="text-sm font-medium text-slate-400 flex items-center gap-2">
                            <span id="statusDot" class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                            <span id="statusText">正在同步数据...</span>
                        </div>
                        <button onclick="doFilter()" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Search</button>
                    </div>
                </section>
                <div id="resultsList" class="space-y-8"></div>
            </div>

            <div>
                <section class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 mb-10">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2 block ml-1">当前 SMG ID</label>
                    <div id="smgIDDisplay" class="text-xl font-black text-indigo-600 mono break-all">
                        --
                    </div>
                </section>

                <section id="csvGenerationSection" class="mb-10">
                    <h2 class="text-2xl font-bold mb-4">CSV Generation</h2>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">CSV Headers</label>
                            <div id="csvHeadersContainer" class="mb-2"></div>
                            <div class="flex">
                                <input type="text" id="newHeaderInput" class="input-pill w-full mr-2" placeholder="Add new header">
                                <button onclick="addCsvHeader()" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Add</button>
                            </div>
                        </div>
                        <button onclick="generateCSV()" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Generate CSV</button>
                    </div>
                </section>

                <section id="selectedPairsSection" class="mb-10">
                    <h2 class="text-2xl font-bold mb-4">Selected Token Pairs</h2>
                    <div id="selectedPairsTableContainer" class="bg-white p-4 rounded-lg shadow-sm border border-slate-100">
                        <!-- Selected token pairs table will be displayed here -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <div id="hexTool" class="fixed bottom-24 right-8 w-96 bg-white rounded-3xl shadow-2xl border border-slate-200 hidden z-50 overflow-hidden">
        <div class="bg-slate-900 p-5 text-white flex justify-between items-center">
            <span class="font-bold">Hex ➔ Binary 工具</span>
            <button onclick="toggleTool()" class="text-slate-400 hover:text-white text-xl">✕</button>
        </div>
        <div class="p-6 space-y-5">
            <textarea id="hexInput" class="w-full h-28 bg-slate-50 border rounded-xl p-4 mono outline-none text-sm" placeholder="粘贴 Hex 字符串..."></textarea>
            <div class="bg-indigo-50 p-4 rounded-xl">
                <span class="text-xs font-bold text-indigo-400 uppercase block mb-2">解码文本</span>
                <div id="textOutput" class="text-base font-bold text-indigo-700 break-all"></div>
            </div>
            <div class="bg-slate-900 p-4 rounded-xl">
                <span class="text-xs font-bold text-slate-500 uppercase block mb-2">二进制流</span>
                <div id="binOutput" class="text-[11px] mono text-emerald-400 h-32 overflow-y-auto leading-relaxed"></div>
            </div>
        </div>
    </div>

    <button onclick="toggleTool()" class="fixed bottom-8 right-8 w-16 h-16 bg-slate-900 text-white rounded-2xl shadow-xl flex items-center justify-center hover:scale-110 transition-transform">
        <span class="font-bold tracking-tighter">HEX</span>
    </button>

    <script>
        let isTestnet = false;
        let allPairs = [];
        let selectedPairsData = [];
        let manuallySwappedPairIDs = new Set();
        let csvHeaders = ['id', 'smg', 'token_name', 'token_pair_id', 'from_token_address', 'from_token_tokendecimals', 'network_fee', 'network_fee_asset'];
        let baseUrl = "https://bridge-api.wanchain.org/api/";
        let rawSmgID = '';
        let currentRenderedPairs = new Map();

        const shortenAddress = (address) => {
            if (typeof address !== 'string' || address.length < 10) return address;
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        };

        const hexToUtf8 = s => { try { return decodeURIComponent(s.replace(/\s+/g, '').replace(/[0-9a-f]{2}/g, '%$&')); } catch(e) { return s; } };

        const getDisplayName = (symbol) => {
            if (!symbol) return '';
            const decoded = hexToUtf8(symbol);
            if (decoded === symbol) {
                return symbol;
            }
            // Check for non-printable ASCII characters to avoid showing garbage
            for (let i = 0; i < decoded.length; i++) {
                const charCode = decoded.charCodeAt(i);
                if (charCode < 32 || charCode > 126) {
                    return symbol;
                }
            }
            return decoded;
        };

        async function syncData() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            statusDot.className = "w-2.5 h-2.5 rounded-full bg-amber-400 animate-pulse";
            statusText.innerText = "正在更新数据池...";
            try {
                const res = await fetch(baseUrl + "tokenPairs").then(r => r.json());
                allPairs = res.data || [];
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
                statusText.innerText = `已加载 ${allPairs.length} 条路径`;
                doFilter();
            } catch (e) {
                statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
                statusText.innerText = `同步失败`;
            }
        }

        function showSuggestions(inputId, suggestId, mode) {
            const val = document.getElementById(inputId).value.trim().toLowerCase();
            const listEl = document.getElementById(suggestId);
            if (!val) { listEl.style.display = 'none'; return; }
            let pool = (mode === 'chain') ? allPairs.flatMap(p => [p.fromChain.chainName, p.toChain.chainName]) : allPairs.map(p => p.symbol);
            const uniqueMatches = [...new Set(pool)].filter(name => name.toLowerCase().startsWith(val)).sort();
            if (uniqueMatches.length > 0) {
                listEl.innerHTML = uniqueMatches.map(m => `<div class="suggest-item" onclick="selectItem('${inputId}', '${suggestId}', '${m}')">${m}</div>`).join('');
                listEl.style.display = 'block';
            } else { listEl.style.display = 'none'; }
        }

        function selectItem(inputId, suggestId, val) {
            document.getElementById(inputId).value = val;
            document.getElementById(suggestId).style.display = 'none';
        }

        function doFilter() {
            const asset = document.getElementById('assetIn').value.trim().toLowerCase();
            const valA = document.getElementById('chainA').value.trim().toLowerCase();
            const valB = document.getElementById('chainB').value.trim().toLowerCase();
            if (!asset && !valA && !valB) { document.getElementById('resultsList').innerHTML = ""; return; }

            const matches = allPairs.map(p => {
                const sym = (p.symbol || "").toLowerCase();
                const symUtf8 = hexToUtf8(p.symbol).toLowerCase();
                const fromC = (p.fromChain.chainName || "").toLowerCase();
                const toC = (p.toChain.chainName || "").toLowerCase();
                const assetMatch = !asset || sym.includes(asset) || symUtf8.includes(asset);

                if (!assetMatch) return null;

                // Case 1: Both networks are specified
                if (valA && valB) {
                    const straightMatch = fromC.includes(valA) && toC.includes(valB);
                    const reverseMatch = fromC.includes(valB) && toC.includes(valA);
                    if (straightMatch) return { ...p, _isSwapped: false };
                    if (reverseMatch) return { ...p, _isSwapped: true };
                }
                // Case 2: Only one network is specified
                else if (valA || valB) {
                    const singleTerm = valA || valB;
                    if (fromC.includes(singleTerm)) return { ...p, _isSwapped: false };
                    if (toC.includes(singleTerm)) return { ...p, _isSwapped: true };
                }
                // Case 3: Only asset is specified
                else if (asset) {
                     return { ...p, _isSwapped: false };
                }

                return null;
            }).filter(Boolean);

            renderResults(matches);
        }

        function renderCard(p, isSearchSwapped = false) {
            const name = getDisplayName(p.symbol);

            // Determine the final direction based on both search and manual swaps
            const isManuallySwapped = manuallySwappedPairIDs.has(p.tokenPairID);
            const shouldBeSwapped = isManuallySwapped ? !isSearchSwapped : isSearchSwapped;

            const fromChain = shouldBeSwapped ? p.toChain : p.fromChain;
            const toChain = shouldBeSwapped ? p.fromChain : p.toChain;
            const fromToken = shouldBeSwapped ? p.toToken : p.fromToken;
            const toToken = shouldBeSwapped ? p.fromToken : p.toToken;

            const directionalID = `${p.tokenPairID}_${fromChain.chainName}_${toChain.chainName}`;
            const pairForOnClick = { ...p, fromChain, toChain, fromToken, toToken, directionalID };
            currentRenderedPairs.set(directionalID, pairForOnClick); // Store data in the map
            const isSelected = selectedPairsData.some(sp => sp.directionalID === directionalID);

            return `
            <div class="result-card overflow-hidden" id="card-${p.tokenPairID}">
                <div class="p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-8">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 bg-indigo-600 rounded-2xl flex items-center justify-center text-white text-2xl font-black shadow-lg shadow-indigo-100">${name.substring(0,1)}</div>
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="text-2xl font-black text-slate-900">${name}</h3>
                                    <span class="text-[10px] px-2 py-0.5 bg-slate-100 text-slate-500 rounded-md mono font-bold">ID: ${p.tokenPairID}</span>
                                </div>
                                <div class="flex items-center gap-2 mt-1 text-slate-500 font-bold text-sm">
                                    <span>${fromChain.chainName}</span>
                                    <button onclick="event.stopPropagation(); swapPairDirection('${p.tokenPairID}')"
                                            class="p-1 rounded-md hover:bg-slate-100 text-indigo-500 text-xs font-bold">
                                        &#8646; Swap
                                    </button>
                                    <span>${toChain.chainName}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="getFee('${p.tokenPairID}')" class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition text-xs">Get Fee</button>
                            <button onclick="togglePairSelection('${directionalID}')"
                                    class="w-full md:w-auto px-6 py-3 font-bold rounded-xl transition shadow-md ${isSelected ? 'bg-slate-200 text-slate-500 shadow-slate-100' : 'bg-green-500 text-white hover:bg-green-600 shadow-green-100'}">
                                ${isSelected ? 'Added' : '+'}
                            </button>
                        </div>
                    </div>
                    <div id="fee-info-${p.tokenPairID}" class="hidden mt-4 p-4 bg-gray-100 rounded-lg"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 text-sm px-8">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-black text-slate-400 uppercase">源链 Token 地址</span>
                                <button id="btn-from-addr-${p.tokenPairID}" onclick="toggleAddressEncoding('from-addr-${p.tokenPairID}', this)" class="text-xs font-bold text-indigo-500 hover:text-indigo-700 p-1">解码</button>
                            </div>
                            <code id="from-addr-${p.tokenPairID}" data-original-address="${fromToken.address}" class="mono text-slate-700 break-all">${fromToken.address}</code>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-black text-slate-400 uppercase">目标链 Token 地址</span>
                                <button id="btn-to-addr-${p.tokenPairID}" onclick="toggleAddressEncoding('to-addr-${p.tokenPairID}', this)" class="text-xs font-bold text-indigo-500 hover:text-indigo-700 p-1">解码</button>
                            </div>
                            <code id="to-addr-${p.tokenPairID}" data-original-address="${toToken.address}" class="mono text-slate-700 break-all">${toToken.address}</code>
                        </div>
                    </div>
                    <div class="px-8 pb-8">
                        <details class="group">
                            <summary class="text-sm font-bold text-slate-400 cursor-pointer hover:text-slate-600 transition flex items-center gap-2">
                                <svg class="w-4 h-4 group-open:rotate-90 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                查看完整 JSON 数据
                            </summary>
                            <div class="mt-4 json-block"><pre>${JSON.stringify(pairForOnClick, null, 2)}</pre></div>
                        </details>
                    </div>
                </div>
            </div>`;
        }

        function renderResults(list) {
            const container = document.getElementById('resultsList');
            currentRenderedPairs.clear(); // Clear the map before rendering new results
            if (list.length === 0) {
                container.innerHTML = `<div class='text-center py-20 text-slate-400 font-medium'>未找到匹配路径</div>`;
                return;
            }
            container.innerHTML = list.map(p => renderCard(p, p._isSwapped)).join('');
        }

        function changeEnv(val) {
            isTestnet = val;
            baseUrl = isTestnet ? "https://bridge-api.wanchain.org/api/testnet/" : "https://bridge-api.wanchain.org/api/";
            document.getElementById('btnMain').className = !isTestnet ? "px-8 py-2.5 rounded-xl text-sm font-bold bg-indigo-600 text-white shadow-lg shadow-indigo-100 transition-all" : "px-8 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition-all";
            document.getElementById('btnTest').className = isTestnet ? "px-8 py-2.5 rounded-xl text-sm font-bold bg-indigo-600 text-white shadow-lg shadow-indigo-100 transition-all" : "px-8 py-2.5 rounded-xl text-sm font-bold text-slate-500 hover:text-indigo-600 transition-all";
            syncData();
            fetchSmgID();
        }

        function toggleAddressEncoding(elementId, buttonEl) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const originalAddress = el.dataset.originalAddress;
            const currentText = el.innerText;

            if (currentText === originalAddress) {
                // It's encoded, so decode it
                el.innerText = hexToUtf8(originalAddress);
                buttonEl.innerText = '编码';
            } else {
                // It's decoded, so encode it
                el.innerText = originalAddress;
                buttonEl.innerText = '解码';
            }
        }

        async function fetchSmgID() {
            const displayEl = document.getElementById('smgIDDisplay');
            displayEl.innerText = 'Loading...';
            try {
                const res = await fetch(`${baseUrl}smgID`).then(r => r.json());
                if (res.success) {
                    rawSmgID = res.data;
                    let displaySmg = hexToUtf8(res.data);
                    // Sanitize by removing all null characters and control characters, then trimming whitespace
                    displaySmg = displaySmg.replace(/[\u0000-\u001F\u007F-\u009F]/g, '').trim();
                    // Also remove leading zeros from the now-sanitized string
                    displaySmg = displaySmg.replace(/^0+/, '');
                    displayEl.innerText = displaySmg.startsWith('0x') ? displaySmg.substring(2) : displaySmg;
                } else {
                    rawSmgID = '';
                    displayEl.innerText = 'Failed to load smgID.';
                }
            } catch (error) {
                console.error('Error fetching smgID:', error);
                rawSmgID = '';
                displayEl.innerText = 'Error loading smgID.';
            }
        }

        function togglePairSelection(directionalID) {
            const pair = currentRenderedPairs.get(directionalID);
            if (!pair) return; // Should not happen if the UI is in sync

            const isSelected = selectedPairsData.some(p => p.directionalID === directionalID);
            if (isSelected) {
                removePairFromSelection(directionalID);
            } else {
                selectedPairsData.push(pair);
            }
            doFilter();
            renderSelectedPairs();
        }

        function swapPairDirection(tokenPairID) {
            if (manuallySwappedPairIDs.has(tokenPairID)) {
                manuallySwappedPairIDs.delete(tokenPairID);
            } else {
                manuallySwappedPairIDs.add(tokenPairID);
            }
            doFilter(); // Re-render to apply the swap state
        }

        async function getFee(tokenPairID) {
            const feeInfoContainer = document.getElementById(`fee-info-${tokenPairID}`);
            feeInfoContainer.innerHTML = 'Loading fee...';
            feeInfoContainer.classList.remove('hidden');

            try {
                const response = await fetch(`${baseUrl}getFee?tokenPairID=${tokenPairID}`);
                const result = await response.json();

                if (result.success) {
                    const fee = result.data.fee;
                    const feeToken = result.data.token;
                    feeInfoContainer.innerHTML = `Fee: ${fee} ${feeToken.symbol}`;
                } else {
                    feeInfoContainer.innerHTML = `Error: ${result.error}`;
                }
            } catch (error) {
                console.error('Error fetching fee:', error);
                feeInfoContainer.innerHTML = 'Error fetching fee information.';
            }
        }

        function removePairFromSelection(directionalID) {
            selectedPairsData = selectedPairsData.filter(p => p.directionalID !== directionalID);
            doFilter(); // Also re-render results to update button state
            renderSelectedPairs();
        }

        function renderSelectedPairs() {
            const container = document.getElementById('selectedPairsTableContainer');
            if (selectedPairsData.length === 0) {
                container.innerHTML = '<div class="text-center py-10"><p class="text-slate-400 font-medium">No token pairs selected.</p></div>';
                return;
            }

            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">
`;
            tableHTML += '<thead class="text-xs text-slate-700 uppercase bg-slate-50">';
            tableHTML += '<tr>';
            csvHeaders.forEach(header => {
                tableHTML += `<th scope="col" class="px-6 py-3">${header.replace(/_/g, ' ')}</th>`;
            });
            tableHTML += '<th scope="col" class="px-6 py-3">Action</th></tr></thead><tbody>';

            let decodedSmgID = document.getElementById('smgIDDisplay').innerText;

            selectedPairsData.forEach((p, index) => {
                const name = getDisplayName(p.symbol);
                const row = {
                    id: index + 1,
                    smg: decodedSmgID, // Display decoded SMG in table
                    token_name: name,
                    token_pair_id: p.tokenPairID,
                    from_token_address: p.fromToken.address,
                    from_token_tokendecimals: p.fromToken.decimals,
                    network_fee: '', // Per user request, fee query is removed, so this is blank
                    network_fee_asset: p.fromChain.chainType
                };

                tableHTML += '<tr class="bg-white border-b hover:bg-slate-50">';
                csvHeaders.forEach(header => {
                    let displayValue = row[header] === undefined || row[header] === null ? '' : row[header];
                    if (header === 'from_token_address') {
                        displayValue = hexToUtf8(String(displayValue));
                    } else if (header === 'to_token_address') {
                        displayValue = shortenAddress(String(displayValue));
                    }
                     tableHTML += `<td class="px-6 py-4 mono font-medium text-slate-800 break-all">${displayValue}</td>`;
                });
                tableHTML += `<td class="px-6 py-4"><button onclick="removePairFromSelection('${p.directionalID}')" class="px-3 py-1 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition text-xs">Remove</button></td></tr>`;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        function addCsvHeader() {
            const newHeaderInput = document.getElementById('newHeaderInput');
            const newHeaders = newHeaderInput.value.trim().split(',').map(h => h.trim()).filter(Boolean);
            if (newHeaders.length > 0) {
                newHeaders.forEach(newHeader => {
                    if (!csvHeaders.includes(newHeader)) {
                        csvHeaders.push(newHeader);
                    }
                });
                newHeaderInput.value = '';
                renderCsvHeaders();
                renderSelectedPairs();
            }
        }

        function removeCsvHeader(header) {
            csvHeaders = csvHeaders.filter(h => h !== header);
            renderCsvHeaders();
            renderSelectedPairs();
        }

        function renderCsvHeaders() {
            const container = document.getElementById('csvHeadersContainer');
            container.innerHTML = csvHeaders.map(header => `
                <div class="header-pill">
                    ${header}
                    <button onclick="removeCsvHeader('${header}')">❌</button>
                </div>
            `).join('');
        }

        function generateCSV() {
            let csvContent = "data:text/csv;charset=utf-8," + csvHeaders.join(",") + "\n";

            selectedPairsData.forEach((p, index) => {
                const name = getDisplayName(p.symbol);
                const row = {
                    id: index + 1,
                    smg: rawSmgID, // Use raw hex SMG for CSV
                    token_name: name,
                    token_pair_id: p.tokenPairID,
                    from_token_address: p.fromToken.address, // Full address for CSV
                    from_token_tokendecimals: p.fromToken.decimals,
                    network_fee: '', // Per user request, fee query is removed, so this is blank
                    network_fee_asset: p.fromChain.chainType
                };

                let rowData = csvHeaders.map(header => {
                    const value = row[header] || '';
                    // Escape commas and quotes for CSV
                    const escapedValue = ('' + value).replace(/"/g, '""');
                    return `"${escapedValue}"`;
                });
                csvContent += rowData.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "token_pairs.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleTool() { document.getElementById('hexTool').classList.toggle('hidden'); }

        document.getElementById('hexInput').addEventListener('input', e => {
            const raw = e.target.value.replace(/^0x/, '').replace(/\./g, '').replace(/\s/g, '');
            let bin = ""; let text = "";
            for (let i = 0; i < raw.length; i++) {
                bin += parseInt(raw[i], 16).toString(2).padStart(4, '0') + " ";
                if (i % 2 === 1) text += String.fromCharCode(parseInt(raw.substr(i-1, 2), 16));
            }
            document.getElementById('binOutput').innerText = bin.trim();
            document.getElementById('textOutput').innerText = text;
        });

        document.addEventListener('click', e => { if (!e.target.closest('.suggest-container')) document.querySelectorAll('.suggest-list').forEach(el => el.style.display = 'none'); });

        changeEnv(false);
        renderCsvHeaders();
    </script>
</body>

</html>
